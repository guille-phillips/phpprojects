<!DOCTYPE html>
<html>
	<head>
		<meta name="description" content="Fixture Wheel">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>Fixture Wheel</title>
		<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
		<script>
			var canvas;
			var userEventController;

			var EVENT_GRAB = 0;
			var EVENT_DRAG = 1;
			var EVENT_MOVE = 2;
			var EVENT_RELEASE = 3;
			var CAPTURE_EVENT = false;
			var PASS_ON_EVENT = true;
			
			var PI2 = 2*Math.PI;
			
			var mutex = false;

/*
			function renderController() {
				var this.delegates = [];
				var self = this;
				this.registerDelegate = function (delegate) {
					this.delegates.push(delegate);
				}

				this.render = function () {
					mutex = true;
					ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

					for (var i=0; i<self.delegates.length; i++) {
						self.delegates[i]();
					}
					mutex = false;
				}
			}
*/

			function eventConroller () {
				this.mouseState = EVENT_RELEASE;
				this.boundingRectangle = canvas.getBoundingClientRect();

				this.previousCoords = undefined;

				this.delegates = [];

				var self = this;

				this.getCoords = function(event) {
					var rect = canvas.getBoundingClientRect();

					if (event.changedTouches) {
						if (event.changedTouches.length==1) {
							//alert('changedTouches')

							return {x:event.changedTouches[0].clientX - rect.left, y:event.changedTouches[0].clientY - rect.top};
						}
					} 

					return {x: event.clientX - rect.left, y: event.clientY - rect.top};
				};

				this.registerDelegate = function (delegate) {
					this.delegates.push(delegate);
				};

				this.createEventListeners = function(canvas) {
					canvas.addEventListener('mousedown',
						function (event) {
							document.getElementById('info2').innerHTML = 'mousedown';

							if (mutex) return;

							self.mouseState = EVENT_GRAB;
							var coords = self.getCoords(event);
//document.getElementById('info2').innerHTML = JSON.stringify(coords);
							for (var i = 0; i<self.delegates.length; i++) {
								if (!self.delegates[i](self.mouseState,coords,self.previousCoords)) break;
							}
							self.previousCoords = coords;
						}
					);

					canvas.addEventListener('mousemove',
						function (event) {
							document.getElementById('info2').innerHTML = 'mousemove';
							if (mutex) return;

							switch (self.mouseState) {
								case EVENT_GRAB:
								case EVENT_DRAG:
									self.mouseState = EVENT_DRAG;
									break;
								default:
									self.mouseState = EVENT_MOVE;
							}

							var coords = self.getCoords(event);
					
							for (var i = 0; i<self.delegates.length; i++) {
								if (!self.delegates[i](self.mouseState,coords,self.previousCoords)) break;
							}

							self.previousCoords = coords;
//document.getElementById('info2').innerHTML = JSON.stringify(coords);											
						}
					);
					
					
					canvas.addEventListener('mouseup',
						function (event) {
							document.getElementById('info2').innerHTML = 'mouseup';
							if (mutex) return;

							self.mouseState = EVENT_RELEASE;
							var coords = self.getCoords(event);
//document.getElementById('info2').innerHTML = JSON.stringify(coords);
							for (var i = 0; i<self.delegates.length; i++) {
								if (!self.delegates[i](self.mouseState,coords,self.previousCoords)) break;
							}			
							self.previousCoords = coords;				
						}
					);

					canvas.addEventListener('mouseout',
						function (event) {
							document.getElementById('info2').innerHTML = 'mouseout';
							if (mutex) return;

							self.mouseState = EVENT_RELEASE;
							var coords = self.getCoords(event);
//document.getElementById('info2').innerHTML = JSON.stringify(coords);
							for (var i = 0; i<self.delegates.length; i++) {
								if (!self.delegates[i](self.mouseState,coords,self.previousCoords)) break;
							}			
							self.previousCoords = coords;				
						}
					);

					canvas.addEventListener('touchstart',
						function (event) {
							document.getElementById('info2').innerHTML = 'touchstart';
							if (mutex) return;

							self.mouseState = EVENT_GRAB;
							var coords = self.getCoords(event);
//document.getElementById('info2').innerHTML = JSON.stringify(coords);
							for (var i = 0; i<self.delegates.length; i++) {
								if (!self.delegates[i](self.mouseState,coords,self.previousCoords)) break;
							}			
							self.previousCoords = coords;				
						}
					);

					canvas.addEventListener('touchmove',
						function (event) {
							document.getElementById('info2').innerHTML = 'touchmove';
							if (mutex) return;

							if (self.mouseState == EVENT_GRAB || self.mouseState == EVENT_DRAG) {
								self.mouseState = EVENT_DRAG;
							} else {
								self.mouseState = EVENT_MOVE;
							}
							var coords = self.getCoords(event);
//document.getElementById('info2').innerHTML = JSON.stringify(coords);
							for (var i = 0; i<self.delegates.length; i++) {
								if (!self.delegates[i](self.mouseState,coords,self.previousCoords)) break;
							}			
							self.previousCoords = coords;				
						}
					);


					canvas.addEventListener('touchend',
						function (event) {
							document.getElementById('info2').innerHTML = 'touchend';
							if (mutex) return;

							self.mouseState = EVENT_RELEASE;
							var coords = self.getCoords(event);
//document.getElementById('info2').innerHTML = JSON.stringify(coords);
							for (var i = 0; i<self.delegates.length; i++) {
								if (!self.delegates[i](self.mouseState,coords,self.previousCoords)) break;
							}			
							self.previousCoords = coords;				
						}
					);

				};
			}


			function wheel (id, segments, context, centre, radius, renderFunction, list) {
				this.segments = segments;
				this.offsetAngle = 0;
				this.context = context;
				this.outsideRadius = radius;
				this.textRadius = 140;
				this.insideRadius = 100;
				this.centre = centre;
				this.selectedSegment = 3;
				this.selected = false;
				this.id = id;
				this.renderFunction = renderFunction;
				this.list = list;
				
				this.velocity = 0.1;
				this.acceleration = 0.02;

				var self = this;

				this.updateMovement = function () {
					if (!self.selected) {
						self.offsetAngle += self.velocity;

						if (self.velocity>0 && self.velocity<=self.acceleration) {
							self.velocity = 0;
							self.acceleration = 0;
						} else if (self.velocity<0 && self.velocity>=self.acceleration) {
							self.velocity = 0;
							self.acceleration = 0;
						}

						self.velocity -= self.acceleration;
					}
				}

				this.render = function () {

					var ctx = self.context;

					ctx.drawImage(image,self.centre.x-self.outsideRadius-3,self.centre.y-self.outsideRadius-3,self.outsideRadius*2+6,self.outsideRadius*2+6);

					ctx.strokeStyle = "black";
					

					var arc = PI2 / segments;
					
					for(var i = 0; i < self.segments; i++) {
						var angle = self.offsetAngle + i * arc;

						if (i==self.selectedSegment) {
							ctx.beginPath();
							ctx.fillStyle = 'rgba(70,70,70,0.8)';
							ctx.arc(self.centre.x, self.centre.y, self.outsideRadius, angle, angle + arc, false);
							ctx.arc(self.centre.x, self.centre.y, self.insideRadius, angle + arc, angle, true);
							ctx.stroke();
							ctx.fill();

							ctx.font = 'bold 12px sans-serif';
						} else {
							ctx.font = '12px sans-serif';
						}

						ctx.beginPath();

						ctx.strokeStyle = 'rgba(0,0,0,0.8)';
						ctx.lineWidth = 1;
						ctx.moveTo(self.centre.x,self.centre.y);
						ctx.lineTo(self.outsideRadius*Math.cos(angle)+self.centre.x,self.outsideRadius*Math.sin(angle)+self.centre.y);					
						ctx.stroke();

						ctx.beginPath();
						ctx.lineWidth = 2;
						ctx.strokeStyle = 'rgba(255,255,255,0.5)';
						ctx.moveTo(self.centre.x,self.centre.y);
						ctx.lineTo(self.outsideRadius*Math.cos(angle)+self.centre.x+2,self.outsideRadius*Math.sin(angle)+self.centre.y);
						ctx.stroke();
						//ctx.fill();

						ctx.save();
						//ctx.shadowOffsetX = -1;
						//ctx.shadowOffsetY = -1;
						//ctx.shadowBlur    = 0;
						//ctx.shadowColor   = "rgb(220,220,220)";

						if (i==self.selectedSegment) {
							ctx.fillStyle = "white";
						} else {
							ctx.fillStyle = "black";
						}
						ctx.translate(self.centre.x + Math.cos(angle + arc / 2) * self.outsideRadius, self.centre.y + Math.sin(angle + arc / 2) * self.outsideRadius);
						ctx.rotate(angle + arc / 2 + Math.PI / 1);
						
						var text = self.list[i];
						if (text) {
							ctx.fillText(text, 10, 0); // ctx.measureText(text).width
						}
						ctx.restore();
					}
				};


				this.remapCoords = function (absoluteCoords) {
					return {x: absoluteCoords.x - self.centre.x, y: absoluteCoords.y - self.centre.y};
				};

				this.distance = function (coord) {
					return Math.sqrt(coord.x*coord.x+coord.y*coord.y);
				};

				this.polarCoords = function (coords) {
					return {angle:Math.atan2(coords.y, coords.x),distance:self.distance(coords)};
				};
				
				this.userEvent = function (eventType,coords,previousCoords) {
					switch (eventType) {
						case EVENT_GRAB:
							coords = self.remapCoords(coords);
							var polar = self.polarCoords(coords);

							if (polar.distance < self.outsideRadius) {
								self.selected = true;
								self.velocity = 0;
								self.acceleration = 0;

								while (polar.angle<0) polar.angle += PI2;
								//self.selectedSegment = Math.floor(self.segments*(polar.angle-self.offsetAngle)/Math.PI/2)%self.segments;
								//self.renderFunction();
								return CAPTURE_EVENT;
							} else {
								return PASS_ON_EVENT;
							}
							break;
						case EVENT_DRAG:
							coords = self.remapCoords(coords);
							previousCoords = self.remapCoords(previousCoords);
							if (self.selected) {
								var angle = Math.atan2(coords.y, coords.x);
								var previousAngle = Math.atan2(previousCoords.y, previousCoords.x);
								self.velocity = 0.6*(angle-previousAngle);
								if (self.velocity>0) {
									self.acceleration = 0.017;
								} else {
									self.acceleration = -0.017;
								}
								self.offsetAngle += angle-previousAngle;
								self.renderFunction();

								return CAPTURE_EVENT; 
							} else {
								return PASS_ON_EVENT;
							}

							break;
						case EVENT_MOVE:
							// do nothing
							return PASS_ON_EVENT; 
							break;
						case EVENT_RELEASE: 
							self.selected = false;
							return PASS_ON_EVENT; 
							break;
					}
				};
			}

			function RenderAll() {
				ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

				var time = (new Date).getTime();
				mutex = true;
		  		wheel1.render();
		  		wheel2.render();
		  		wheel3.render();

		  		wheel1.updateMovement();
		  		wheel2.updateMovement();
		  		wheel3.updateMovement();

		  		mutex = false;
				var total = (new Date).getTime() - time;
				document.getElementById('info1').innerHTML = total;
			}

		  	function initialise() {
				$('#wheelcanvas').css({
				  'position': 'absolute',
				  'bottom': '0px',
				  'left' : '0px'
				});

				image = document.getElementById("disc");
		  		canvas = document.getElementById("wheelcanvas");
		  		
				if (canvas.getContext) {
			  		ctx = canvas.getContext("2d");

					ctx.font = '30px Arial';

					ctx.canvas.width  = window.innerWidth-5;
					ctx.canvas.height = 1.2*window.innerWidth/2+10;

					var middle = window.innerWidth/2;
					var radius = 1.2*window.innerWidth/2;
					var spacing = radius/3;
					var bottom = ctx.canvas.height;

					wheel1 = new wheel(1, 12, ctx, {x:middle,y:bottom+radius-3*spacing}, radius, RenderAll, ['banana','lemon','orange','pineapple','melon','tomato','potato','mango','leek','pear','apple']);
					wheel2 = new wheel(2, 12, ctx, {x:middle,y:bottom+radius-2*spacing}, radius, RenderAll, ['monday','tuesday','wednesday','thursday','friday','saturday','sunday']);
					wheel3 = new wheel(3, 30, ctx, {x:middle,y:bottom+radius-1*spacing}, radius, RenderAll, ['january','february','march','april','may','june','july','august','september','october','november','december']);

					// rendererer = new renderController();
					// rendererer.registerDelegate(wheel1.render);
					// rendererer.registerDelegate(wheel2.render);
					// rendererer.registerDelegate(wheel3.render);

			  		userEventController = new eventConroller();
			  		userEventController.registerDelegate(wheel3.userEvent);			  		
			  		userEventController.registerDelegate(wheel2.userEvent);
			  		userEventController.registerDelegate(wheel1.userEvent);
			  		userEventController.createEventListeners(canvas);

			  		//renderer.render();
			  		setInterval(RenderAll,30);
			  	}
		  	}
		</script>		
		
    </head>
	<body onload='initialise()' style='background: url(BT-Sport-Mobile-InSitu.png) no-repeat; background-size:100%; background-position: 0px -80px'>
		<div id='info1' style='color:white;'>xyz</div>
		<div id='info2' style='color:white;'>abc</div>
		<img id="disc" style="display:none" src="Disc-1080x1080.png">
		<canvas id="wheelcanvas"></canvas>
		<div id="frame"></div>
	</body>
</html>